<aside>
    <script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("TOC Highlight Script Loaded");

    const sections = document.querySelectorAll("article [id]");
    console.log("Detected Sections:", [...sections].map(el => el.id));

    const tocLinks = document.querySelectorAll(".right aside ul a");
    console.log("Detected TOC Links:", tocLinks);

    let lastActiveId = null;
    let isManualScroll = false; // Figyelj√ºk, hogy kattint√°s vagy g√∂rget√©s t√∂rt√©nt-e

    // IntersectionObserver be√°ll√≠t√°s a g√∂rget√©s k√∂vet√©s√©re
    let observer = new IntersectionObserver(entries => {
        if (isManualScroll) return; // Ha √©ppen anchorra kattintottunk, ne zavarjuk meg

        let visibleSections = [];

        entries.forEach(entry => {
            console.log(`Checking section: ${entry.target.id}, isIntersecting: ${entry.isIntersecting}, top: ${entry.boundingClientRect.top}`);

            if (entry.isIntersecting) {
                visibleSections.push({
                    id: entry.target.id,
                    top: entry.boundingClientRect.top
                });
            }
        });

        if (visibleSections.length > 0) {
            // Mindig a viewport tetej√©hez legk√∂zelebbi szakaszt v√°lasszuk akt√≠vnak
            visibleSections.sort((a, b) => a.top - b.top);
            let activeId = visibleSections[0].id;

            if (activeId === lastActiveId) return; // Ha nem v√°ltozott az akt√≠v elem, ne friss√≠ts√ºnk

            lastActiveId = activeId;

            console.log("New Active ID:", activeId);

            // TOC friss√≠t√©se
            tocLinks.forEach(link => link.classList.remove("active"));

            tocLinks.forEach(link => {
                let linkHash = new URL(link.href).hash;
                let linkTargetId = linkHash ? linkHash.substring(1) : null;

                if (linkTargetId === activeId) {
                    console.log(`Setting active: ${linkHash}`);
                    link.classList.add("active");
                }
            });
        }
    }, {
        rootMargin: "-150px 0px -60% 0px", // üî• Figyel√©si magass√°g feljebb tolva a kattint√°s miatt
        threshold: [0.6] // Legal√°bb 60%-ban l√°that√≥nak kell lennie a v√°lt√°shoz
    });

    sections.forEach(section => observer.observe(section));

    // Anchor link kattint√°sra finom√≠tott g√∂rget√©s
    tocLinks.forEach(link => {
        link.addEventListener("click", (event) => {
            event.preventDefault(); // Ne hagyjuk, hogy a b√∂ng√©sz≈ë azonnal ugr√°ljon

            const targetId = new URL(link.href).hash.substring(1);
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                isManualScroll = true; // Kijel√∂lj√ºk, hogy k√©zi g√∂rget√©s t√∂rt√©nt

                targetElement.scrollIntoView({ behavior: "smooth", block: "start" });

                // Id≈ëz√≠t√©s a g√∂rget√©s ut√°n, hogy az akt√≠v elem megfelel≈ëen friss√ºlj√∂n
                setTimeout(() => {
                    isManualScroll = false; // Vissza√°ll√≠tjuk a g√∂rget√©s k√∂vet√©s√©t
                    lastActiveId = targetId;
                    console.log(`Manually setting active: #${targetId}`);

                    tocLinks.forEach(link => link.classList.remove("active"));
                    tocLinks.forEach(link => {
                        if (new URL(link.href).hash.substring(1) === targetId) {
                            link.classList.add("active");
                        }
                    });
                }, 600); // El√©g id≈ët hagyunk a scroll befejez≈ëd√©s√©re
            }
        });
    });
});
    </script>
    {{#empty(page.toc)}}
    {{/empty(page.toc)}}
    {{^empty(page.toc)}}
    <h4>On this page</h4>
    <ul>
    {{#page.toc}}
        <li class="first-level">
            <a href="#{{fragment}}">{{text}}</a>
            <ul>
            {{#children}}
                <li><a href="#{{fragment}}">{{text}}</a></li>
            {{/children}}
            </ul>
        </li>
    {{/page.toc}}
    </ul>
    {{/empty(page.toc)}}
</aside>
